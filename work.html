<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shockwave GCS</title>
    <link rel="stylesheet" href="dark-mode.css" id="dark-mode">
    <link rel="stylesheet" href="light-mode.css" id="light-mode" disabled>
    <link href="bootstrap-5.3.3-dist/css" rel="stylesheet" crossorigin="anonymous">
    <link href='Fonts/ITC Avant Garde Gothic Bold.otf' rel='stylesheet'>
    <link href='Fonts/ITCAvantGardeStd-Demi.ttf' rel='stylesheet'>
    <script src="canvasjs.min.js"></script>
    <link rel="icon" type="image/x-icon" href="">
    <link rel="stylesheet" href="leaflet.css" />
    <script src="leaflet.js"></script>

</head>
<body>
<main>
    <div class="header">
        <div class="logo-img">
            <img src="shockwavelg.png" alt="Shockwave Logo" class="img-thumbnail" width="120" height="120" style="background-color: transparent; border: none;">
        </div>
        <div class="header-text">CanSat Team #2078</div>
        <div id="missionTime">Mission Time: 00:00:00.000</div>
    </div>

    <div class="hero">
        <div class="main-graphs">
            <!-- Graphs go here -->
            <div class="graph" id="altitudeChart"></div>
            <div class="graph" id="temperatureChart"></div>
            <div class="graph" id="pressureChart"></div>
            <div class="graph" id="voltageChart"></div>
            <div class="graph" id="speedChart"></div>
            <div class="graph" id="tiltChart"></div>
            <div class="spacer"></div> <!-- Blank space to center map -->
            <div id="map" style="height: 400px;"></div>
        </div>

        <div class="sidebar-container"> <!-- Correctly contains both sidebars -->
            <div class="sidebar" id="telemetrySidebar">
                <div class="labels">
                    <!-- Telemetry data display -->
                    <div id="packetCount">Packet Count: <strong>0</strong></div>
                    <div id="wsMessageCount">Packets Received: <strong>0</strong></div>
                    <div id="Mode">Mode: <strong>F</strong></div>
                    <div id="State">State: <strong>Not Connected</strong></div>
                    <div id="HSStatus">Heat Shield Deployed: <strong>N</strong></div>
                    <div id="PCStatus">Parachute Deployed: <strong>N</strong></div>
                    <div id="VoltageLabel">Voltage: <strong>0V</strong></div>
                    <div id="RotZ">Rotation Z: <strong>0°/s</strong></div>
                    <div id="GPSTime">GPS Time: <strong>00:00:00.000 UTC</strong></div>
                    <div id="GPSAltitude">GPS Altitude: <strong>0°</strong></div>
                    <div id="GPSLatitude">GPS Latitude: <strong>0°</strong></div>
                    <div id="GPSLongitude">GPS Longitude: <strong>0m</strong></div>
                    <div id="GPSSats">Satellites: <strong>0</strong></div>
                    <div id="CMDEcho">Command Echo: <strong>None</strong></div>
                </div>
            </div>

            <div class="sidebar" id="buttonSidebar">
                <!-- Button Row 1 -->
                <div class="button-row">
                    <button class="sidebar-btn" data-message="CMD,2078,SIM,AC,GOAT">Sim Activate</button>
                    <button class="toggle-btn off" data-message-on="CMD,2078,SIM,EN,GOAT" data-message-off="CMD,2078,SIM,DS,GOAT" data-on-label="Sim: E" data-off-label="Sim: D">Sim: D</button>
                </div>

                <!-- Button Row 2 -->
                <div class="button-row">
                    <button class="sidebar-btn" data-message="CMD,2078,CAL,GOAT">Calibrate</button>
                    <button class="toggle-btn off" data-message-on="CMD,2078,CX,ON,GOAT" data-message-off="CMD,2078,CX,OFF,GOAT" data-on-label="T: On " data-off-label="T: Off">T: Off</button>
                </div>

                <!-- Button Row 3 -->
                <div class="button-row">
                    <button class="sidebar-btn" data-message="CMD,2078,ST,UTC,GOAT">UTC Time</button>
                    <button class="toggle-btn off" data-message-on="CMD,2078,BCN,ON,GOAT" data-message-off="CMD,2078,BCN,OFF,GOAT" data-on-label="A: On " data-off-label="A: Off">A: Off</button>
                </div>

                <!-- Button Row 4 -->
                <div class="button-row">
                    <button class="sidebar-btn" data-message="CMD,2078,ST,GPS,GOAT">GPS <-> UTC</button>
                    <button id="themeToggle" class="toggle-btn off" data-on-label="Dark" data-off-label="Light">Dark</button>
                </div>


                <!-- Button Row 5 -->
                <div class="button-row">
                    <button class="sidebar-btn" data-message="CMD,2078,SERVO,ON,GOAT">Release</button>
                </div>

            </div>

        </div> <!-- Closing sidebar-container div here -->
    </div>
</main>

<script src="canvasjs.min.js"></script>
<script type="text/javascript">
    var altitudeChart, temperatureChart, pressureChart, voltageChart, speedChart, tiltChart; // Declare charts as global variables
    // Initialize the WebSocket message count as 0
    let wsMessageCount = 0; //  initialization to ensure it's an integer
    // Data points for each of our graphs
    let lastPacketCount = 0; // Variable to store the last packet count
    // Data points for each of our graphs
    let altitudeDataPoints = [];
    let temperatureDataPoints = [];
    let pressureDataPoints = [];
    let voltageDataPoints = [];
    let speedDataPoints = [];
    let tiltDataPoints = [];
    let myMap, marker;

    function initCharts() {
        altitudeChart = new CanvasJS.Chart("altitudeChart", { // Altitude Chart
            title: { text: "Altitude (m)", fontColor: "purple", fontFamily: "IB" },
            axisX: { title: "Time", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            axisY: { title: "Altitude (m)", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            backgroundColor: "white",
            data: [{ type: "spline", dataPoints: altitudeDataPoints, color: "purple" }]
        });

        temperatureChart = new CanvasJS.Chart("temperatureChart", { // Temperature Chart
            title: { text: "Temperature (°C)", fontColor: "purple", fontFamily: "IB" },
            axisX: { title: "Time", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            axisY: { title: "Temperature (°C)", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            backgroundColor: "white",
            data: [{ type: "spline", dataPoints: temperatureDataPoints, color: "purple" }]
        });

        pressureChart = new CanvasJS.Chart("pressureChart", { // Air Pressure Chart
            title: { text: "Air Pressure (kPa)", fontColor: "purple", fontFamily: "IB" },
            axisX: { title: "Time", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            axisY: { title: "Pressure (kPa)", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            backgroundColor: "white",
            data: [{ type: "spline", dataPoints: pressureDataPoints, color: "purple" }]
        });

        voltageChart = new CanvasJS.Chart("voltageChart", { // Voltage Chart
            title: { text: "Voltage (v)", fontColor: "purple", fontFamily: "IB" },
            axisX: { title: "Time", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            axisY: { title: "Voltage (v)", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            backgroundColor: "white",
            data: [{ type: "spline", dataPoints: voltageDataPoints, color: "purple" }]
        });

        speedChart = new CanvasJS.Chart("speedChart", { // Air Speed Chart
            title: { text: "Air Speed (m/s)", fontColor: "purple", fontFamily: "IB" },
            axisX: { title: "Time", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            axisY: { title: "Speed (m/s)", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            backgroundColor: "white",
            data: [{ type: "spline", dataPoints: speedDataPoints, color: "purple" }]
        });

        tiltChart = new CanvasJS.Chart("tiltChart", { // Tilt X & Y Chart
            title: { text: "Tilt (°)", fontColor: "purple", fontFamily: "IB" },
            axisX: { title: "Tilt X (°)", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            axisY: { title: "Tilt Y (°)", labelFontColor: "purple", titleFontColor: "purple", labelFontFamily: "ISB", titleFontFamily: "ISB" },
            backgroundColor: "white",
            data: [{ type: "spline", dataPoints: tiltDataPoints, color: "purple" }]
        });

        altitudeChart.render(); // Render new chart
        temperatureChart.render(); // Render new chart
        pressureChart.render(); // Render new chart
        voltageChart.render(); // Render new chart
        speedChart.render(); // Render new chart
        tiltChart.render(); // Render new chart

        myMap = L.map('map').setView([38.6129629, -79.5826993], 13); // Initialize the map and set its view 34.725380, -86.639783
        L.tileLayer('Flight/{z}/{x}/{y}.png', { // Use relative path to point to your local tiles
            maxZoom: 15,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(myMap);
        marker = L.marker([38.6129629, -79.5826993]).addTo(myMap); // Initialize a marker
    }

    // Adding data to charts
    function updateCharts(packetCount, altitude, temperature, pressure, voltage, speed, tiltx, tilty) {
        console.log(`Updating charts with packetCount: ${packetCount}, altitude: ${altitude}, temperature: ${temperature}, pressure: ${pressure}, voltage: ${voltage}, air_speed: ${speed}, tiltX: ${tiltx}, tiltY: ${tilty}`);

        // Check for packet count reset condition
        if (packetCount < lastPacketCount) {
            console.log("Resetting data points due to packet count decrease.");
            // Reset data points arrays
            altitudeDataPoints = [];
            temperatureDataPoints = [];
            pressureDataPoints = [];
            voltageDataPoints = [];
            speedDataPoints = [];
            tiltDataPoints = [];

            // Clear the chart data series as well
            altitudeChart.options.data[0].dataPoints = altitudeDataPoints;
            temperatureChart.options.data[0].dataPoints = temperatureDataPoints;
            pressureChart.options.data[0].dataPoints = pressureDataPoints;
            voltageChart.options.data[0].dataPoints = voltageDataPoints;
            speedChart.options.data[0].dataPoints = speedDataPoints;
            tiltChart.options.data[0].dataPoints = tiltDataPoints;

            // Render the charts to reflect cleared data
            altitudeChart.render();
            temperatureChart.render();
            pressureChart.render();
            voltageChart.render();
            speedChart.render();
            tiltChart.render();
        }

        lastPacketCount = packetCount; // Update the last known packet count

        // Add new data points
        altitudeDataPoints.push({ x: packetCount, y: altitude });
        temperatureDataPoints.push({ x: packetCount, y: temperature });
        pressureDataPoints.push({ x: packetCount, y: pressure });
        voltageDataPoints.push({ x: packetCount, y: voltage });
        speedDataPoints.push({ x: packetCount, y: speed });
        tiltDataPoints.push({ x: tiltx, y: tilty });

        // Check if the length exceeds a maximum value, if so, remove the oldest data point
        if (altitudeDataPoints.length > 40) altitudeDataPoints.shift();
        if (temperatureDataPoints.length > 40) temperatureDataPoints.shift();
        if (pressureDataPoints.length > 40) pressureDataPoints.shift();
        if (voltageDataPoints.length > 40) voltageDataPoints.shift();
        if (speedDataPoints.length > 40) speedDataPoints.shift();
        if (tiltDataPoints.length > 3) tiltDataPoints.shift(); // Tilt has a smaller threshold

        // Render the charts to update the view
        altitudeChart.render();
        temperatureChart.render();
        pressureChart.render();
        voltageChart.render();
        speedChart.render();
        tiltChart.render();
    }



    function updateMapLocation(gpslatitude, gpslongitude) {
        if (myMap && marker) {
            // Convert the GPS coordinates to the correct format
            const latitude = gpslatitude / 10000000;
            const longitude = gpslongitude / 10000000;

            // Update marker position
            marker.setLatLng([latitude, longitude]);

            // Optionally, center the map on the new marker location without zooming
            myMap.setView([latitude, longitude], myMap.getZoom());
        }
    }



    // WebSocket message handler
    // WebSocket message handler

    function connectWebSocket() {
        ws = new WebSocket("ws://localhost:2078/ws");
        ws.onmessage = function(event) {
            const arr = event.data.toString().split(',');
            processWebSocketData(arr);
        };
        ws.onclose = function(event) {
            console.log(`WebSocket is closed. Attempting to reconnect, reason: ${event.reason}`);
            setTimeout(connectWebSocket, 1000); // Reconnect after 1 second
        };
        ws.onerror = function(event) {
            console.error("WebSocket error observed:", event);
        };
    }



    function processWebSocketData(arr) {
        wsMessageCount++;
        document.getElementById("wsMessageCount").textContent = `Packets Received: ${wsMessageCount}`;

        if (arr.length >= 21) { // This is an arbitrary length check; adjust based on actual data structure
            const missionTime = arr[1].trim();
            document.getElementById("missionTime").textContent = `Mission Time: ${missionTime}`;

            const packetCountIndex = 2;
            const packetCount = parseFloat(arr[packetCountIndex].trim());
            document.getElementById("packetCount").textContent = `Packet Count: ${packetCount}`;
            const voltageCountIndex = 10;
            const voltage = parseFloat(arr[voltageCountIndex].trim());
            document.getElementById("VoltageLabel").textContent = `Voltage: ${voltage}v`;

            const satCountIndex = 16;
            const sat = parseInt(arr[satCountIndex].trim(), 10);
            document.getElementById("GPSSats").textContent = `Satellites: ${sat}`;

            const modeCountIndex = 3;
            const mode = arr[modeCountIndex].trim();
            document.getElementById("Mode").textContent = `Mode: ${mode}`;

            const stateCountIndex = 4;
            const state = arr[stateCountIndex].trim();
            document.getElementById("State").textContent = `State: ${state}`;

            const hsCountIndex = 7;
            const hs = arr[hsCountIndex].trim();
            document.getElementById("HSStatus").textContent = `Heat Shield Deployed: ${hs}`;

            const pcCountIndex = 8;
            const pc = arr[pcCountIndex].trim();
            document.getElementById("PCStatus").textContent = `Parachute Deployed: ${pc}`;

            const rzCountIndex = 19;
            const rz = arr[rzCountIndex].trim();
            document.getElementById("RotZ").textContent = `Rotation Z: ${rz}°/s`;

            const gpstimeCountIndex = 12;
            const gpstime = arr[gpstimeCountIndex].trim();
            document.getElementById("GPSTime").textContent = `GPS Time: ${gpstime} UTC`;

            console.log("Current GPS Time:", gpstime);

            const gpsaltitudeCountIndex = 13;
            const gpsaltitude = parseFloat(arr[gpsaltitudeCountIndex].trim()) / 1000;
            document.getElementById("GPSAltitude").textContent = `GPS Altitude: ${gpsaltitude}m`;

            const CMDEchoCountIndex = 20;
            const cmdecho = arr[CMDEchoCountIndex].trim();
            document.getElementById("CMDEcho").textContent = `Current Command: ${cmdecho}`;

            const gpslatitudeIndex = 14;
            const gpslongitudeIndex = 15;
            const gpslatitude = parseFloat(arr[gpslatitudeIndex].trim());
            const gpslongitude = parseFloat(arr[gpslongitudeIndex].trim());

            document.getElementById("GPSLatitude").textContent = `GPS Latitude: ${(gpslatitude / 10000000).toFixed(7)}°`;
            document.getElementById("GPSLongitude").textContent = `GPS Longitude: ${(gpslongitude / 10000000).toFixed(7)}°`;

            console.log("Received GPS coordinates:", gpslatitude, gpslongitude);
            updateMapLocation(gpslatitude, gpslongitude);

            const altitude = parseFloat(arr[5].trim());
            const temperature = parseFloat(arr[9].trim());
            const pressure = parseFloat(arr[11].trim());
            const speed = parseFloat(arr[6].trim());
            const tiltx = parseFloat(arr[17].trim());
            const tilty = parseFloat(arr[18].trim());
            updateCharts(packetCount, altitude, temperature, pressure, voltage, speed, tiltx, tilty);
        }
    }


    document.addEventListener('DOMContentLoaded', function() {
        const themeToggle = document.getElementById('themeToggle'); // Get the theme toggle button by ID

// Initialize the theme based on saved preferences or system settings
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const darkModeSheet = document.getElementById('dark-mode');
            const lightModeSheet = document.getElementById('light-mode');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

            if (savedTheme) {
                if (savedTheme === 'light') {
                    lightModeSheet.removeAttribute('disabled');
                    darkModeSheet.setAttribute('disabled', 'disabled');
                    themeToggle.textContent = 'Light Mode';
                } else {
                    darkModeSheet.removeAttribute('disabled');
                    lightModeSheet.setAttribute('disabled', 'disabled');
                    themeToggle.textContent = 'Dark Mode';
                }
            } else if (prefersDarkScheme.matches) {
                darkModeSheet.removeAttribute('disabled');
                lightModeSheet.setAttribute('disabled', 'disabled');
                themeToggle.textContent = 'Light Mode';
            } else {
                lightModeSheet.removeAttribute('disabled');
                darkModeSheet.setAttribute('disabled', 'disabled');
                themeToggle.textContent = 'Dark Mode';
            }
        }

// Theme toggle click event
        themeToggle.addEventListener('click', function() {
            const darkModeSheet = document.getElementById('dark-mode');
            const lightModeSheet = document.getElementById('light-mode');

            if (darkModeSheet.disabled) {
                darkModeSheet.removeAttribute('disabled');
                lightModeSheet.setAttribute('disabled', 'disabled');
                this.textContent = 'Dark Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                lightModeSheet.removeAttribute('disabled');
                darkModeSheet.setAttribute('disabled', 'disabled');
                this.textContent = 'Light Mode';
                localStorage.setItem('theme', 'light');
            }
        });

        initializeTheme(); // Apply the initial theme setting

        // Event listeners for other toggle buttons
        const toggles = document.querySelectorAll('.toggle-btn');
        toggles.forEach(toggle => {
            if (toggle.id !== 'themeToggle') { // Exclude the theme toggle button
                toggle.addEventListener('click', function() {
                    if (this.classList.contains('off')) {
                        this.classList.remove('off');
                        this.classList.add('on', 'pressed');
                        this.textContent = this.getAttribute('data-on-label');
                        logAndSendMessage(this.getAttribute('data-message-on'), this.textContent);
                    } else {
                        this.classList.remove('on', 'pressed');
                        this.classList.add('off');
                        this.textContent = this.getAttribute('data-off-label');
                        logAndSendMessage(this.getAttribute('data-message-off'), this.textContent);
                    }
                });
            }
        });

        // Event listeners for non-toggle buttons (sidebar-btn)
        const sidebarBtns = document.querySelectorAll('.sidebar-btn');
        sidebarBtns.forEach(button => {
            button.addEventListener('click', function() {
                const message = this.getAttribute('data-message');
                logAndSendMessage(message, this.textContent);
            });
        });

        function logAndSendMessage(message, buttonText) {
            console.log(`Button pressed: ${buttonText} sending message: ${message}`);
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                console.log(`Message sent over WebSocket: ${message}`);
            } else {
                console.log('WebSocket is not connected.');
            }
        }
    });



    window.onload = function() {
        initCharts();
        connectWebSocket(); // Initialize WebSocket connection
    };

</script>
</body>
</html>
